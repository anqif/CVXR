#####
## DO NOT EDIT THIS FILE!! EDIT THE SOURCE INSTEAD: rsrc_tree/reductions/dgp2dcp/atom_canonicalizers/add_canon.R
#####

## CVXPY SOURCE: cvxpy/reductions/dgp2dcp/atom_canonicalizers/add_canon.py
#######################################################################
#                         Atom canonicalizers
#######################################################################

#'
#' Dgp2Dcp canonicalizer for the addition atom
#'
#' @param expr An \linkS4class{Expression} object
#' @param args A list of values for the expr variable
#' @return A canonicalization of the addition atom of a DGP expression,
#' where the returned expression is the transformed DCP equivalent.
Dgp2Dcp.add_canon <- function(expr, args) {
  if(is_scalar(expr))
    return(list(log_sum_exp(do.call("HStack", args)), list()))
  expr_dim <- dim(expr)

  rows <- list()
  summands <- lapply(args, function(s) { if(is_scalar(s)) promote(s, dim(expr)) else s })
  if(length(expr_dim) == 1) {
    for(i in seq_len(expr_dim[1])) {
      summand_args <- lapply(summands, function(summand) { summand[i] })
      row <- log_sum_exp(do.call("HStack", summand_args))
      rows <- c(rows, list(row))
    }
    return(list(reshape_expr(bmat(rows), expr_dim), list()))
  } else {
    for(i in seq_len(expr_dim[1])) {
      row <- list()
      for(j in seq_len(expr_dim[2])) {
        summand_args <- lapply(summands, function(summand) { summand[i,j] })
        row <- c(row, list(log_sum_exp(do.call("HStack", summand_args))))
      }
      rows <- c(rows, list(row))
    }
    return(list(reshape_expr(bmat(rows), expr_dim), list()))
  }
}
